# Build binary wheels for all supported platforms and publish to PyPI.
#
# Triggered automatically when you push a version tag (e.g. v2.8.0).
# Can also be triggered manually from the Actions tab (workflow_dispatch).
#
# Publishing uses PyPI Trusted Publishing (OIDC) — no API token required.
# One-time setup on PyPI: see README or the comment at the bottom of this file.

name: Build and publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # ── 1. Build wheels (C++ compiled) ─────────────────────────────────────────
  build_wheels:
    name: Wheels · ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false   # don't cancel other platforms if one fails
      matrix:
        include:
          - os: ubuntu-latest   # Linux x86_64 (manylinux)
          - os: windows-latest  # Windows x86_64
          - os: macos-14        # macOS Apple Silicon arm64

    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        # cibuildwheel reads [tool.cibuildwheel] from pyproject.toml.
        # cmake and ninja are installed automatically from the build-system
        # requires list before cibuildwheel runs each build.

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: dist-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  # ── 2. Build source distribution ───────────────────────────────────────────
  build_sdist:
    name: Source distribution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        run: pipx run build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*.tar.gz

  # ── 3. Publish to PyPI ──────────────────────────────────────────────────────
  publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest

    # Only publish when triggered by a version tag, not workflow_dispatch
    if: startsWith(github.ref, 'refs/tags/v')

    environment:
      name: pypi
      url: https://pypi.org/project/hvrt/

    permissions:
      id-token: write   # required for OIDC trusted publishing

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

# ── PyPI Trusted Publisher setup (one-time, done on the PyPI website) ─────────
#
# Trusted Publishing lets GitHub Actions publish without an API token.
# You set it up once on PyPI and never touch it again.
#
# Steps:
#   1. Log in to pypi.org → go to your project → Publishing → Add publisher
#      (If the project doesn't exist yet, go to pypi.org/manage/account/publishing/
#       and use "Add a new pending publisher" instead.)
#
#   2. Fill in the form:
#        Owner (GitHub username/org):  hotprotato
#        Repository name:              hvrt
#        Workflow filename:            build_wheels.yml
#        Environment name:             pypi
#
#   3. Click "Add". That's it — no tokens, no secrets.
#
# To publish a new release:
#   git tag v2.8.0
#   git push origin v2.8.0
#
# The workflow starts automatically, builds ~15 wheels across 3 platforms,
# and uploads everything to PyPI when done (~10–15 minutes total).
